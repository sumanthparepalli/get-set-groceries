<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!--suppress CheckTagEmptyBody -->
    <th:block th:insert="fragments/header :: head"></th:block>
    <title>Login</title>
    <style>
        /* Chrome, Safari, Edge, Opera */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/header :: preload"></th:block>
<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/header :: menu"></th:block>
<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/header :: header"></th:block>
<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/header :: hero-content"></th:block>


<!----------------------------------------------------- Content Begins ------------------------------------------------>

<!-- Breadcrumb Section Begin -->
<section class="breadcrumb-section set-bg" data-setbg="/img/breadcrumb.jpg">
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <div class="breadcrumb__text">
                    <h2>Shopping Cart</h2>
                    <div class="breadcrumb__option">
                        <a href="/">Home</a>
                        <span>Shopping Cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Breadcrumb Section End -->

<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/header :: flash-messages"></th:block>

<!-- Shoping Cart Section Begin -->
<section class="shoping-cart spad" th:if="${cartModel != null}">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="shoping__cart__table">
                    <!--                    <form th:action="@{/cart}" th:method="POST" th:object="${order}" id="cart">-->
                    <form th:action="@{/cart}" th:method="post" th:object="${cartModel}" id="cartForm">
                        <input type="hidden" th:field="*{order.id}">
                        <table>
                            <thead>
                            <tr>
                                <th class="shoping__product">Products</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="orderItem,i : ${cartModel.orderDetails}">
                                <td class="shoping__cart__item">
                                    <img src="img/cart/cart-1.jpg" alt="">
                                    <h5 th:text="*{orderDetails[__${i.index}__].product.name}">
                                        Veggies</h5>
                                </td>
                                <td class="shoping__cart__price" th:text="*{orderDetails[__${i.index}__].pricePerUnit}">
                                    $55.00
                                </td>
                                <td class="shoping__cart__quantity">
                                    <div class="quantity">
                                        <div class="pro-qty">
                                            <input type="number"
                                                   th:field="*{orderDetails[__${i.index}__].quantity}"
                                                   th:value="*{orderDetails[__${i.index}__].quantity}">
                                        </div>
                                    </div>
                                </td>
                                <td class="shoping__cart__total" th:text="*{orderDetails[__${i.index}__].price}">
                                    $110.00
                                </td>
                                <!--<td>
                                    <input type="submit" value="Update" class="btn btn-light">
                                </td>-->
                                <td class="shoping__cart__item__close">
                                    <input type="hidden" th:field="*{orderDetails[__${i.index}__].id}">
                                    <a th:href="|/cart/remove/*{orderDetails[__${i.index}__].id}|"><span
                                            class="icon_close"></span></a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </form>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="shoping__cart__btns">
                    <a href="/" class="primary-btn cart-btn">CONTINUE SHOPPING</a>
                    <button form="cartForm" class="primary-btn cart-btn cart-btn-right border-0"><span
                            class="icon_loading"></span>
                        Update Cart
                    </button>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="shoping__continue">
                    <div class="shoping__discount">
                        <h5>Discount Codes</h5>
                        <form action="#">
                            <input type="text" placeholder="Enter your coupon code">
                            <button type="submit" class="site-btn">APPLY COUPON</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="shoping__checkout">
                    <h5>Cart Total</h5>
                    <ul>
                        <li>Subtotal <span th:text="${cartModel.order.amount}" id="total">$454.98</span></li>
                        <li>Promotion(incl. credit bal+disc) <span th:text="${cartModel.order.promotion}" >$454.98</span></li>
                        <li>Total <span th:text="${cartModel.order.total}" id="total2">$454.98</span></li>
                    </ul>
<!--                    <a href="#" class="primary-btn">PROCEED TO CHECKOUT</a>-->
                    <img
                            alt="Visa Checkout"
                            class="v-button"
                            role="button"
                            src="https://sandbox.secure.checkout.visa.com/wallet-services-web/xo/button.png"
                    />
                </div>
            </div>
        </div>
    </div>
</section>
<section class="shoping-cart spad" th:if="${cartModel == null}">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <p class="h3 text-center"> No products in your cart </p>
            </div>
        </div>
    </div>
</section>
<!-- Shoping Cart Section End -->

<!----------------------------------------------------- Content Ends ------------------------------------------------>

<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/footer :: footer"></th:block>
<!--suppress CheckTagEmptyBody -->
<th:block th:insert="fragments/footer :: scripts"></th:block>
<th:block th:insert="fragments/footer :: checkout-scripts" th:if="${cartModel != null}"> </th:block>
<script th:inline="javascript" th:if="${cartModel != null}">
    function onVisaCheckoutReady() {
        V.init({
            apikey: "3LXNZKOIF92IZSK6ENHZ21cV7A_TdR5y6u08gqnUP2tujkhRE",
            encryptionKey: "XEXL13IOWKBH18TIO3GO13bFMW28iFzEdVO_Xia_GQVFxc2uA",
            paymentRequest: {
                currencyCode: "INR",
                subtotal: /*[[${cartModel.order.amount}]]*/ '0'
            }
        });
        V.on("payment.success", async function (payment) {
            console.log(payment);
            let response = await fetch('http://localhost:8082/payment/checkout/' + payment.callid, {
                method: 'POST',
                headers: {
                    'Content-Type': "application/json"
                }
            });
            const res = await response.json();
            Promise.resolve(res).then(r => {
                if(res.status == 200)
                    window.location.href = "http://localhost:8082/payment/success";
                else
                    alert(res.message);
            });
        });
        V.on("payment.error", () => {
            alert("Error in payment, try again");
        })
    }
</script>
</body>
</html>